# ==========================================
# 1. CORE SERVER SETUP
# ==========================================
server.port=8080
spring.application.name=api-gateway

# ==========================================
# 2. EUREKA CONFIG (Docker Usable)
# ==========================================
# FIX 1: Hostname must be dynamic. 
# In Docker, this becomes the container ID (random string) or service name.
# We default to 'localhost' ONLY for local dev.
eureka.instance.hostname=${EUREKA_INSTANCE_HOSTNAME:localhost}

# FIX 2: In Docker, we MUST prefer IP address so containers can find each other.
# We default to 'true' for Docker compatibility.
eureka.instance.prefer-ip-address=${EUREKA_INSTANCE_PREFER_IP_ADDRESS:true}

# FIX 3: Dynamic Instance ID
eureka.instance.instance-id=${spring.application.name}:${eureka.instance.hostname}:${server.port}

# FIX 4: Registry URL must be dynamic.
# In Docker, we will inject 'http://service-registry:8761/eureka/'
eureka.client.service-url.defaultZone=${EUREKA_URI:http://localhost:8761/eureka/}

# ==========================================
# 3. GATEWAY ROUTING
# ==========================================
spring.cloud.gateway.discovery.locator.enabled=true
spring.cloud.gateway.discovery.locator.lower-case-service-id=true

# Route 1: Portfolio Service
spring.cloud.gateway.routes[0].id=portfolio-service
spring.cloud.gateway.routes[0].predicates[0]=Path=/api/portfolio/**
# Use UpperCase to match Eureka ID safely
spring.cloud.gateway.routes[0].uri=lb://PORTFOLIO-SERVICE

# Route 2: Identity Service
spring.cloud.gateway.routes[1].id=identity-service
spring.cloud.gateway.routes[1].predicates[0]=Path=/auth/**
spring.cloud.gateway.routes[1].uri=lb://IDENTITY-SERVICE

# ==========================================
# 4. TRACING (Zipkin)
# ==========================================
# Use the correct Spring Boot 3 property for Zipkin endpoint
management.zipkin.tracing.endpoint=${ZIPKIN_URL:http://zipkin:9411/api/v2/spans}
management.tracing.sampling.probability=1.0

# Logging Pattern
logging.pattern.level=%5p [${spring.application.name:},%X{traceId:-},%X{spanId:-}]